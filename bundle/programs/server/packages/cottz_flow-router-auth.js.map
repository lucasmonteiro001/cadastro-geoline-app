{"version":3,"sources":["meteor://ðŸ’»app/packages/cottz:flow-router-auth/flow-router-auth.js"],"names":[],"mappings":"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","file":"/packages/cottz_flow-router-auth.js","sourcesContent":["class FlowAuth {\n  constructor () {\n    this.controllers = new Mongo.Collection(null);\n    this.redirect = 'notFound';\n    this.hasPermission = new ReactiveVar(false);\n    this.authReady = new ReactiveVar(true);\n  }\n  allow (callback, options) {\n    check(callback, Function);\n\n    const controller = {\n      action: callback,\n      createdAt: (new Date()).getTime()\n    };\n\n    if (options) {\n      options.except\n      ? controller.except = options.except\n      : controller.only = options.only || options\n      controller.redirect = options.redirect\n    };\n\n    if (typeof controller.only == 'object' && !Array.isArray(controller.only)) {\n      const groupId = Random.id();\n      const group = controller.only;\n\n      if (!group.auth) group.auth = [];\n      group.auth.push(groupId);\n\n      controller.only = groupId;\n    }\n    this.controllers.insert(controller);\n  }\n  allows (controllers) {\n    for (let c of controllers) {\n      this.allow(c.action, c);\n    };\n  }\n  check (path, group, redirect) {\n    let next = true;\n    let only = path;\n\n    this.authReady.set(false);\n\n    if (group) {\n      const auth = [];\n\n      while (group) {\n        if (group.auth)\n          auth.push(group.auth);\n        group = group.parent;\n      };\n\n      if (auth.length) {\n        auth.unshift(only);\n        only = {$in: _.flatten(auth)};\n      }\n    }\n\n    this.controllers.find({\n      $or: [\n        {only},\n        {except: {$ne: path}, only: null}\n      ]\n    }, {sort: {createdAt: 1}}).forEach(route => {\n      if (!next) return;\n\n      next = route.action();\n\n      if (!next) {\n        typeof redirect === 'function'\n        ? redirect(route.redirect || this.redirect)\n        : FlowRouter.go(route.redirect || this.redirect);\n      }\n    });\n\n    this.authReady.set(true);\n    this.hasPermission.set(next);\n  }\n  permissionGranted () {\n    return this.hasPermission.get();\n  }\n  ready () {\n    return this.authReady.get();\n  }\n};\n// ----------------------------------------------------------------------\nFlowRouter.Auth = new FlowAuth();"]}